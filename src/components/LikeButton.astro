---
type Props = {
  postSlug: string;
  serverLikes: number;
};

const { postSlug, serverLikes } = Astro.props;
---

<button class="pt-20 data-[liked]:bg-red-500" data-post-slug={postSlug}
  >{serverLikes}</button
>

<script>
  import { actions } from "astro:actions";

  const button = document.querySelector("button[data-post-slug]")!;
  const postSlug = button.getAttribute("data-post-slug")!;

  button.toggleAttribute("data-liked", Boolean(localStorage.getItem("isLike")));

  button.addEventListener("click", async () => {
    const isLike = !Boolean(localStorage.getItem("isLike"));
    button.toggleAttribute("data-liked", isLike);

    if (isLike) {
      localStorage.setItem("isLike", "true");
    } else {
      localStorage.removeItem("isLike");
    }

    const { data, error } = await actions.like.safe({
      postSlug,
      isLike: isLike,
    });

    // TODO: funny easter egg for too many requests
    if (error) return;

    button.textContent = data.likes.toString();
  });
</script>
